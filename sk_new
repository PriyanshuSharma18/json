# writer_service.py
import os
from dataclasses import dataclass

from dotenv import load_dotenv
from fastapi import FastAPI
from pydantic import BaseModel

from semantic_kernel import Kernel
from semantic_kernel.connectors.ai.open_ai import AzureChatCompletion
from semantic_kernel.functions import KernelFunctionFromPrompt


# =============================
#  SK + AZURE SETUP
# =============================

def build_kernel() -> Kernel:
    load_dotenv()  # loads .env in the same folder

    api_key = os.getenv("AZURE_OPENAI_API_KEY")
    endpoint = os.getenv("AZURE_OPENAI_ENDPOINT")
    api_version = os.getenv("AZURE_OPENAI_API_VERSION", "2024-12-01-preview")
    deployment_name = os.getenv("AZURE_OPENAI_DEPLOYMENT_NAME")

    if not api_key or not endpoint or not deployment_name:
        raise RuntimeError(
            "Missing Azure env vars: AZURE_OPENAI_API_KEY / AZURE_OPENAI_ENDPOINT / AZURE_OPENAI_DEPLOYMENT_NAME"
        )

    print("[WriterService] Using endpoint:", endpoint)
    print("[WriterService] Using deployment:", deployment_name)

    kernel = Kernel()

    chat_service = AzureChatCompletion(
        service_id="azure-gpt4o",
        api_key=api_key,
        endpoint=endpoint,
        deployment_name=deployment_name,
        api_version=api_version,
    )

    kernel.add_service(chat_service)
    return kernel


@dataclass
class WriterAgent:
    kernel: Kernel

    def __post_init__(self):
        self._func = KernelFunctionFromPrompt(
            function_name="writer_agent",
            plugin_name="email_agents",
            prompt=(
                "You are an expert email writer agent.\n"
                "Task: Write a clear, concise, professional email.\n\n"
                "User intent / instructions:\n"
                "{{ $input }}\n\n"
                "Constraints:\n"
                "- Polite, professional tone.\n"
                "- Under 250 words.\n"
                "- Output ONLY the email body, no explanations."
            ),
        )

    async def run(self, instruction: str) -> str:
        result = await self.kernel.invoke(self._func, input=instruction)
        return str(result)


# =============================
#  FASTAPI APP
# =============================

class AgentRequest(BaseModel):
    input: str


class AgentResponse(BaseModel):
    agent: str
    output: str


app = FastAPI(title="Writer Agent Service")

print("[WriterService] Building kernel...")
kernel = build_kernel()
writer_agent = WriterAgent(kernel)
print("[WriterService] Ready.")


@app.post("/invoke", response_model=AgentResponse)
async def invoke_writer(payload: AgentRequest):
    print("[WriterService] Received request")
    output = await writer_agent.run(payload.input)
    return AgentResponse(agent="writer", output=output)
